#!/bin/bash
# path to unpack source into


##############################################################################
##### SOFTWARE SOURCES ######################################################
##############################################################################
RURL=https://cran.rstudio.com/src/base/R-4
RFILE=R-4.0.2.tar.gz

SHINYFILE=shiny-server-1.5.14.948-amd64.deb
SHINYURL=https://download3.rstudio.org/ubuntu-14.04/x86_64
##############################################################################
##############################################################################
##############################################################################



##############################################################################
##### CHECK ENVIORNMENT VARIABLES#############################################
##############################################################################
[[ -z "$SRCPATH" ]] && \
  SRCPATH=/usr/local/scr || \
  echo "SRCPATH WAS ALREADY SET TO $SRCPATH"

mkdir -- "$SRCPATH"
chown $USER "$SRCPATH"
chmod u+rwx "$SRCPATH"

[[ -z "$BUILDPATH" ]] && \
  BUILDPATH=/usr/local || \
  echo "BUILDPATH WAS ALREADY SET TO $BUILDPATH"

[[ -z "$LOGPATH" ]] && \
  LOGPATH="$GIS_UTILS_DIR/sh_logs" || \
  echo "LOGPATH WAS ALREADY SET TO $BUILDPATH"

mkdir -- "$LOGPATH"

[[ -z "$NJOBS" ]] && \
  NJOBS=4 || \
  echo "JOBS IS SET TO $NJOBS"
##############################################################################
##############################################################################
##############################################################################


##############################################################################
##### INSTALL R DEPENDENCIES #################################################
##############################################################################
# add keys
apt-key adv --keyserver keyserver.ubuntu.com --recv-keys E298A3A825C0D65DFD57CBB651716619E084DAB9
sh -c 'echo "deb https://cloud.r-project.org/bin/linux/ubuntu bionic-cran40/" >> /etc/apt/sources.list'


# preps for using build-dep
# https://askubuntu.com/questions/496549/error-you-must-put-some-source-uris-in-your-sources-list

cp /etc/apt/sources.list /etc/apt/sources.list~
sed -Ei 's/^# deb-src /deb-src /' /etc/apt/sources.list


apt update
apt build-dep -y r-base
##############################################################################
##############################################################################
##############################################################################


##############################################################################
####  MAKE R #################################################################
##############################################################################
cd -- "$SRCPATH"

wget ftp://ftp.pcre.org/pub/pcre/pcre2-10.35.tar.gz
tar -xzvf pcre2-10.35.tar.gz
cd -- "pcre2-10.35"

./configure
make
make check
make install
##############################################################################
##############################################################################
##############################################################################


##############################################################################
####  MAKE R #################################################################
##############################################################################
RVERS=${RFILE%.tar.gz}
RVERS=${RVERS#R-}

cd -- "$SRCPATH"
wget "$RURL/$RFILE"
tar -xzvf "/$SRCPATH/$RFILE"
cd -- "/$SRCPATH/${RFILE%.tar.gz}"

#./configure LIBnn=lib \

./configure
  --enable-R-shlib
make -j $NJOBS
make check 
make install

# necessary? I don't know
# sudo ln -s /opt/R/$RVERS/bin/R /bin/R 
##############################################################################
##############################################################################
##############################################################################


##############################################################################
####  INSTALL R PACKAGES FIRST ###############################################
##############################################################################
# required for devtools
apt install libssl-dev

sudo su - \
-c "R -e \"install.packages(c('shiny','rmarkdown'), repos='https://cran.rstudio.com/')\""
##############################################################################
##############################################################################
##############################################################################


##############################################################################
####  INSTALL SHINY-SERVER  ##################################################
##############################################################################
### install Shiny-Server
cd -- "$SRCPATH"
sudo apt install -y gdebi-core
wget "$SHINYURL/$SHINYFILE"
sudo gdebi -n $SHINYFILE
##############################################################################
##############################################################################
##############################################################################


# configure with: 
#   source ubuntu-gis-utils/config/config-shiny-server.sh

